
julio.hsu@julio-machine:~/beat_this$ PYTHONPATH=. python3 launch_scripts/train.py
/home/julio.hsu/.local/lib/python3.10/site-packages/rotary_embedding_torch/rotary_embedding_torch.py:35: FutureWarning: `torch.cuda.amp.autocast(args...)` is deprecated. Please use `torch.amp.autocast('cuda', args...)` instead.
  @autocast(enabled = False)
/home/julio.hsu/.local/lib/python3.10/site-packages/rotary_embedding_torch/rotary_embedding_torch.py:262: FutureWarning: `torch.cuda.amp.autocast(args...)` is deprecated. Please use `torch.amp.autocast('cuda', args...)` instead.
  @autocast(enabled = False)
Seed set to 0
Seed set to 0
Starting a new run with the following parameters:
Namespace(name='', gpu=0, force_flash_attention=False, compile=['frontend', 'transformer_blocks', 'task_heads'], n_layers=6, transformer_dim=512, frontend_dropout=0.1, transformer_dropout=0.2, lr=0.0008, weight_decay=0.01, logger='none', num_workers=8, n_heads=16, fps=50, loss='shift_tolerant_weighted_bce', warmup_steps=1000, max_epochs=100, batch_size=4, accumulate_grad_batches=8, train_length=1500, dbn=False, eval_trim_beats=5, val_frequency=5, tempo_augmentation=True, pitch_augmentation=True, mask_augmentation=True, sum_head=True, partial_transformers=True, length_based_oversampling_factor=0.65, val=True, hung_data=False, fold=None, seed=0, checkpoint_path=None, finetune_lr=None, freeze_frontend=False, freeze_transformer=False, freeze_heads=False)
data_dir /home/julio.hsu/beat_this/beat_this/data
checkpoint_dir launch_scripts/checkpoints
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Validation set: 388 items from: frank
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Skipping frank/Schubert_Impromptu_op because not all necessary spectrograms are there.
Training set oversampled from 1560 to 5216 excerpts.
Training set: 5216 items from: frank
Using positive weights:  {'beat': 21, 'downbeat': 100}
Loading checkpoint from final0.ckpt
Using 16bit Automatic Mixed Precision (AMP)
Using default `ModelCheckpoint`. Consider installing `litmodels` package to enable `LitModelCheckpoint` for automatic upload to the Lightning model registry.
GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
HPU available: False, using: 0 HPUs
/home/julio.hsu/.local/lib/python3.10/site-packages/pytorch_lightning/trainer/connectors/logger_connector/logger_connector.py:76: Starting from v1.9.0, `tensorboardX` has been removed as a dependency of the `pytorch_lightning` package, due to potential conflicts with other packages in the ML ecosystem. For this reason, `logger=True` will use `CSVLogger` as the default logger, unless the `tensorboard` or `tensorboardX` packages are found. Please `pip install lightning[extra]` or one of them to enable TensorBoard support by default
Freezing transformer_blocks component
Freezing task_heads component
Total parameters: 20251712
Trainable parameters: 1305038 (6.44%)
Will compile model frontend
Will compile model transformer_blocks
Will compile model task_heads
Using 16bit Automatic Mixed Precision (AMP)
GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
HPU available: False, using: 0 HPUs
/home/julio.hsu/.local/lib/python3.10/site-packages/pytorch_lightning/callbacks/model_checkpoint.py:654: Checkpoint directory /home/julio.hsu/beat_this/launch_scripts/checkpoints exists and is not empty.
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
Loading `train_dataloader` to estimate number of stepping batches.

  | Name          | Type                 | Params | Mode
---------------------------------------------------------------
0 | model         | BeatThis             | 20.3 M | train
1 | beat_loss     | ShiftTolerantBCELoss | 0      | train
2 | downbeat_loss | ShiftTolerantBCELoss | 0      | train
---------------------------------------------------------------
1.3 M     Trainable params
18.9 M    Non-trainable params
20.3 M    Total params
81.007    Total estimated model params size (MB)
236       Modules in train mode
0         Modules in eval mode
Epoch 0:   0%|                                                                                                               | 0/1304 [00:00<?, ?it/s]W0509 03:32:29.522000 264491 torch/_inductor/utils.py:1250] [0/1] Not enough SMs to use max_autotune_gemm mode
Epoch 0:   1%|▍                                                                                          | 7/1304 [01:03<3:14:53,  0.11it/s, v_num=11]/home/julio.hsu/.local/lib/python3.10/site-packages/torch/optim/lr_scheduler.py:182: UserWarning: Detected call of `lr_scheduler.step()` before `optimizer.step()`. In PyTorch 1.1.0 and later, you should call them in the opposite order: `optimizer.step()` before `lr_scheduler.step()`.  Failure to do this will result in PyTorch skipping the first value of the learning rate schedule. See more details at https://pytorch.org/docs/stable/optim.html#how-to-adjust-learning-rate
  warnings.warn(
Epoch 0:  39%|███████████████████████████████████▋                                                       | 511/13Epoch 0:  39%|█████████████████████▏                                | 512/1304 [13:15<20:29,  0.64it/s, v_num=11]Epoch 0:  99%|████████████████████████████████████████████████████▎| 1287/1304 [31:48<00:25,  0.67it/s, v_num=11]Epoch 0:  99%|████████████████████████████████████████████████████▎| 1288/1304 [31:51<00:23,  0.67it/s, v_num=11]Epoch 4: 100%|███████████████████████████████████| 1304/1304 [31:27<00:00,  0.69it/s, v_num=11, train_loss=0.810]/home/julio.hsu/.local/lib/python3.10/site-packages/mir_eval/beat.py:91: UserWarning: Reference beats are empty.]
  warnings.warn("Reference beats are empty.")
                                                                                                                 /home/julio.hsu/.local/lib/python3.10/site-packages/mir_eval/beat.py:93: UserWarning: Estimated beats are empty.]
  warnings.warn("Estimated beats are empty.")
Epoch 15:  29%|████████████████████▎                                                  | 374/1304 [09:01<22:25,  0.69it/s, v_num=11, train_loss=0.636, val_loss=0.794, val_F-measure_beat=0.746, val_F-measure_downbeat=0.695]Epoch 15:  38%|██████████████████████████▋                                            | 489/1304 [11:47<19:39,  0.69it/s, v_num=11, train_loss=0.636, valEpoch 15:  38%|█████████████▉                       | 490/1304 [11:49<19:37,  0.69it/s, v_num=11, train_loss=0.636, val_loss=0.794, val_F-measure_beat=0.746, val_F-measure_downbeat=0.695]Epoch 15:  38%|██████████████          Epoch 15:  38%|▍| 498/1304 [12:00<19:26,  0.69it/s, v_num=11, train_loss=0.636, val_loss=0.794, val_F-measure_beat=0.746, val_F-measure_downbeat=0.6Epoch 15:  64%|███████████████████████▋             | 833/1304 [20:05<11:21,  0.69it/s, v_num=11, train_loss=0.636, val_loss=0.794, val_Epoch 15:  74%|████████████████████████████████████████████████████▊                  | 970/1304 [23:23<08:03,  0.69it/s, v_num=11, train_loss=0.636, val_loss=0.794, val_F-measure_beat=0.746, val_F-measure_downbeat=0.695]Epoch 15:  77%|██████████████████████████████████████████████████████▎                | 998/1304 [24:04<07:22,  0.69it/s, v_num=11, train_loss=0.636, val_loss=0.794, val_F-measure_beat=0.746, val_F-measurEpoch 15:  77%|████████████████████████████▎        | 999/1304 [24:05<07:21,  0.69it/s, v_num=11, train_loss=0.636, val_loss=0.794, val_F-measure_beat=0.746, val_F-measure_downbeat=0.695]Epoch 15:  94%|█████████████████████████████████▊  Epoch 15:  94%|█████████████████████████████████████████████████████████████████▉    | 1229/1304 [29:31<01:48,  0.69it/s, v_num=11, traiEpoch 15:  94%|█████████████████████████████████▉  | 1230/1304 [29:33<01:46,  0.69it/s, v_num=11, train_loss=0.636, val_loss=0.794, val_F-measure_beat=0.746, val_F-measure_downbeat=0.695]Epoch 15:  95%|██████████████████████████████████▏ | 1239/1304 [29:46<01:33,  0.69it/s, v_num=11, train_loss=0.636, val_loss=0.794, val_F-measure_beat=0.746, val_F-measure_downbeat=0.695]Epoch 15:  99%|███████████████████████████████████▋| 1293/1304 [31:04<00:15,  0.69it/s, v_num=11, train_loss=0.636, val_loss=0.794, val_F-measure_beat=0.Epoch 15: 100%|███████████████████Epoch 15: 100%|████████████████████████████████████| 1304/1304 [31:21<00:00,  0.69it/s, v_num=11, train_loss=0.636, val_loss=0.794, val_F-measure_beat=0.746, val_F-measure_downbeat=0.695]Epoch 16:  35%|█████████████                        | 459/1304 [11:03<20:22,  0.69it/s, v_num=11, train_loss=0.645, val_loss=0.794, val_F-measure_beaEpoch 16:  35%|███████▊              | 460/1304 [11:05<20:20,  0.69it/s, v_num=11, train_loss=0.645, val_loss=0.794, val_F-measure_beat=0.746, val_F-measure_downbeat=0.695]Epoch 16:  38%|████████▎             | 493/1304 [11:53<19:33,  0.69it/s, v_num=11, train_loss=0.645, val_loss=0.794, val_F-measure_bEpoch 18:  16%|████████▊                Epoch 18:  16%|███▍                  | 206/1304 [04:58<26:28,  0.69it/s, v_num=11, train_loss=0.624, val_loss=0.794, val_F-measure_beat=0.746, val_F-measure_downbeat=0.695]Epoch 18:  20%|████▍                 | 261/1304 [06:17<25:09,  0.69it/s, v_num=11, Epoch 18:  50%|█████████████████Epoch 18:  50%|█████████▌         | 655/1304 [15:47<15:38,  0.69it/s, v_num=11, train_loss=0.624, val_loss=0.794, val_F-measure_beat=0.746, val_F-measure_downbeat=0.695]Epoch 20:  41%|███████▊           | 537/1304 [07:09<10:13,  1.25it/s, v_num=11, train_loss=0.616, val_loss=0.744, val_F-measure_beat=0.736, val_F-measure_downbeat=0.694]Epoch 20:  76%|██████████████▍    | 989/1304 [13:11<04:12,  1.25it/s, v_num=11, train_loss=0.616, val_loss=0.744, val_F-measure_beat=0.736, val_F-measure_downbEpoch 38:  26%|██████████████▌
Epoch 38:  26%|█████████▋                           | 340/1304 [04:32<12:51,  1.25it/s, v_num=11, train_loss=0.547, val_loss=0.773, val_F-measure_beat=0.757, val_F-measure_downbeat=0.713]Epoch 38:  27%|██████████         Epoch 38:  32%|███████████████████████                                                | 423/1304 [05:38<11:45,  1.25it/s, v_num=11, train_loss=0.547, val_loss=0.773, val_F-measure_beat=0.757, val_F-measure_downbeat=0.713]Epoch 38:  33%|███████████████████████                                                | 424/1304 [05:39<11:45,  1.25it/s, v_num=11, train_loss=0.547, val_loss=0.773, val_F-measure_beat=0.757, val_F-measure_downbeat=0.713]Epoch 49:  23%|████████████████                                                      Epoch 49:  23%|████████▍                            | 296/1304 [03:45<12:49,  1.31it/s, v_num=11, train_loss=0.511, val_loss=0.791, val_F-measure_beat=0.754, val_F-measure_downbeat=0.713]Epoch 61:  22%|████████▏                            | 287/1304 [03:49<13:33,  1.25Epoch 61:  22%|▏| 288/1304 [03:50<13:33,  1.25it/s, v_num=11, train_loss=0.488, val_loss=0.845, val_F-measure_beaEpoch 61:  98%|▉| 1273/1304 [16:57<00:24,  1.25it/s, v_num=11, train_loss=0.488, val_loss=0.845, val_F-Epoch 61:  98%|▉| 1274/1304 [16:58<00:23,  1.25it/s, v_num=11, train_loss=0.488, val_loss=0.845, val_F-measure_beat=0.763, valEpoch 61:  98%|▉|Epoch 62:   2%|▍                      | 24/1304 [00:19<17:26,  1.22it/s, v_num=11, train_loss=0.483, val_loss=0.845, val_F-measure_beaEpoch 62:   2%|  | 25/1304 [00:20<17:05,  1.25it/s, v_num=11, train_loss=0.483, val_loss=0.845, val_F-measure_beat=0.763, val_F-measure_downbeat=0.716]Epoch 64:  46%|▍| 599/1304 [07:58<09:23,  1.25it/s, v_num=1Epoch 66:  83%|█████████████████▎   | 1078/1304 [14:20<03:00,  1.25it/s, v_num=11, train_loss=0.482, val_loss=0.802, val_F-measure_beat=0.76
Epoch 66:  83%|████████████████████████████████▎      | 1079/1304 [14:21<02:59,  1.25it/s, v_num=11, train_loss=0.482, val_loss=0.802, val_F-measure_beat=0.764, val_F-measure_downbeat=0.Epoch 66:  83%|████████████████████████████▉      | 1080/1304 [14:22<02:58,  1.25it/s, v_num=11, train_loss=0.482, val_loss=0.802, val_F-measure_beat=0.764, val_F-measure_downbeat=0.710]Epoch 66:  86%|█████████████████████████████▉     | 1117/1304 [14:52<02:29,  1.25it/s, v_num=11, train_loss=0.482, val_loss=0.802, vEpoch 66:  86%|██████████████▌  | 1118/1304 [14:52<02:28,  1.25it/s, v_num=11, train_loss=0.482, val_loss=0.802, val_F-measure_beat=0.764, val_F-measure_downbeat=0.710]Epoch 93:  44%|███████▊          | 570/1304 [07:30<09:40,  1.26it/s, v_num=11, train_loss=0.455, val_loss=0.851, val_F-measure_beat=0.759, val_F-meaEpoch 93:  44%|██████▏       | 571/1304 [07:31<09:39,  1.26it/s, v_num=11, train_loss=0.455, val_loss=0.851, val_F-measure_beat=0.759, val_F-measure_downbeat=0.711]Epoch 97:  34%|████▋         | 439/1304 [05:51<11:33,  1.25it/s, v_num=11, train_loss=0.442, val_loss=0.851, val_F-measurEpoch 99:  30%|█████████████████████▍                                                 | 393/1304 [05:14<12:10,  1.25it/s, v_num=11, train_loss=0.454, val_loss=0.851, val_F-measure_beat=0.758, val_F-measure_downbeat=0.713]Epoch 99: 100%|██████████████████████████████████████████████████████████████████████| 1304/1304 [18:00<00:00,  1.21it/s, v_num=11, train_loss=0.451, val_loss=0.860, val_F-measure_beat=0.757, val_F-measure_downbeat=0.714]`Trainer.fit` stopped: `max_epochs=100` reached.
Epoch 99: 100%|██████████████████████████████████████████████████████████████████████| 1304/1304 [18:00<00:00,  1.21it/s, v_num=11, train_loss=0.451, val_loss=0.860, val_F-measure_beat=0.757, val_F-measure_downbeat=0.714]
Skipping gtzan/gtzan_jazz_00018 because it has 1 columns but downbeat is supposed to be there.
Skipping gtzan/gtzan_jazz_00003 because it has 1 columns but downbeat is supposed to be there.
Skipping gtzan/gtzan_jazz_00014 because it has 1 columns but downbeat is supposed to be there.
Skipping gtzan/gtzan_jazz_00009 because it has 1 columns but downbeat is supposed to be there.
Skipping gtzan/gtzan_jazz_00020 because it has 1 columns but downbeat is supposed to be there.
Skipping gtzan/gtzan_jazz_00010 because it has 1 columns but downbeat is supposed to be there.
Test set: 993 items from: gtzan
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
Testing DataLoader 0:  13%|█████████████████████                                                                                                                                           | 131/993 [00:48<05:16,  2.72it/s]/home/julio.hsu/.local/lib/python3.10/site-packages/mir_eval/beat.py:93: UserWarning: Estimated beats are empty.
  warnings.warn("Estimated beats are empty.")
/home/julio.hsu/.local/lib/python3.10/site-packages/mir_eval/beat.py:463: UserWarning: Only one estimated beat was provided, so beat intervals cannot be computed.
  warnings.warn(
Testing DataLoader 0: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 993/993 [03:28<00:00,  4.76it/s]
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
       Test metric             DataLoader 0
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
     test_AMLt_beat         0.8372833728790283
   test_AMLt_downbeat       0.7423559427261353
     test_CMLt_beat         0.7367419600486755
   test_CMLt_downbeat       0.6019574999809265
    test_Cemgil_beat        0.7895033359527588
  test_Cemgil_downbeat      0.7062745690345764
   test_F-measure_beat       0.854536771774292
 test_F-measure_downbeat    0.7437989115715027
        test_loss           1.1670513153076172
     test_loss_beat         0.44718995690345764
   test_loss_downbeat       0.7198616862297058
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
